@model MerkaCentro.Application.DTOs.CreatePurchaseOrderDto
@{
    ViewData["Title"] = "Nueva Orden de Compra";
    var suppliers = ViewBag.Suppliers as SelectList;
    var products = ViewBag.Products as List<MerkaCentro.Application.DTOs.ProductDto> ?? new List<MerkaCentro.Application.DTOs.ProductDto>();
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">
        <i class="bi bi-box-seam me-2"></i>Nueva Orden de Compra
    </h1>
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Volver
    </a>
</div>

<form asp-action="Create" method="post" id="orderForm">
    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Items</h5>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addItem()">
                        <i class="bi bi-plus me-1"></i>Agregar Item
                    </button>
                </div>
                <div class="card-body p-0">
                    <table class="table mb-0" id="itemsTable">
                        <thead>
                            <tr>
                                <th style="width: 40%">Producto</th>
                                <th style="width: 20%">Cantidad</th>
                                <th style="width: 25%">Costo Unitario</th>
                                <th style="width: 15%">Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="3" class="text-end fw-bold">Total Orden:</td>
                                <td class="fw-bold fs-5" id="orderTotal">S/ 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informacion</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label asp-for="SupplierId" class="form-label">Proveedor <span class="text-danger">*</span></label>
                        <select asp-for="SupplierId" class="form-select" asp-items="suppliers">
                            <option value="">Seleccione un proveedor</option>
                        </select>
                        <span asp-validation-for="SupplierId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Notes" class="form-label">Notas</label>
                        <textarea asp-for="Notes" class="form-control" rows="4" placeholder="Notas adicionales..."></textarea>
                        <span asp-validation-for="Notes" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                    <i class="bi bi-check-lg me-1"></i>Crear Orden
                </button>
                <a asp-action="Index" class="btn btn-outline-secondary">Cancelar</a>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const products = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(products.Select(p => new { p.Id, p.Name, p.PurchasePrice })));
        let itemCount = 0;

        function addItem() {
            const tbody = document.getElementById('itemsBody');
            const row = document.createElement('tr');
            row.id = `item-${itemCount}`;
            row.innerHTML = `
                <td>
                    <select name="Items[${itemCount}].ProductId" class="form-select product-select" onchange="updatePrice(${itemCount})" required>
                        <option value="">Seleccione...</option>
                        ${products.map(p => `<option value="${p.id}" data-price="${p.purchasePrice}">${p.name}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" name="Items[${itemCount}].Quantity" class="form-control quantity-input"
                           value="1" min="1" step="1" onchange="calculateTotal(${itemCount})" required />
                </td>
                <td>
                    <div class="input-group">
                        <span class="input-group-text">S/</span>
                        <input type="number" name="Items[${itemCount}].UnitCost" class="form-control cost-input"
                               value="0" min="0.01" step="0.01" onchange="calculateTotal(${itemCount})" required />
                    </div>
                </td>
                <td class="item-total align-middle">S/ 0.00</td>
                <td>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(${itemCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            itemCount++;
            updateSubmitButton();
        }

        function removeItem(index) {
            const row = document.getElementById(`item-${index}`);
            if (row) {
                row.remove();
                reindexItems();
                updateOrderTotal();
                updateSubmitButton();
            }
        }

        function reindexItems() {
            const rows = document.querySelectorAll('#itemsBody tr');
            rows.forEach((row, idx) => {
                row.id = `item-${idx}`;
                row.querySelector('.product-select').name = `Items[${idx}].ProductId`;
                row.querySelector('.quantity-input').name = `Items[${idx}].Quantity`;
                row.querySelector('.cost-input').name = `Items[${idx}].UnitCost`;
                row.querySelector('.product-select').setAttribute('onchange', `updatePrice(${idx})`);
                row.querySelector('.quantity-input').setAttribute('onchange', `calculateTotal(${idx})`);
                row.querySelector('.cost-input').setAttribute('onchange', `calculateTotal(${idx})`);
                row.querySelector('.btn-outline-danger').setAttribute('onclick', `removeItem(${idx})`);
            });
            itemCount = rows.length;
        }

        function updatePrice(index) {
            const row = document.getElementById(`item-${index}`);
            const select = row.querySelector('.product-select');
            const costInput = row.querySelector('.cost-input');
            const option = select.options[select.selectedIndex];
            const price = option.dataset.price || 0;
            costInput.value = parseFloat(price).toFixed(2);
            calculateTotal(index);
        }

        function calculateTotal(index) {
            const row = document.getElementById(`item-${index}`);
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const cost = parseFloat(row.querySelector('.cost-input').value) || 0;
            const total = quantity * cost;
            row.querySelector('.item-total').textContent = `S/ ${total.toFixed(2)}`;
            updateOrderTotal();
        }

        function updateOrderTotal() {
            const totals = document.querySelectorAll('.item-total');
            let orderTotal = 0;
            totals.forEach(el => {
                const value = parseFloat(el.textContent.replace('S/ ', '')) || 0;
                orderTotal += value;
            });
            document.getElementById('orderTotal').textContent = `S/ ${orderTotal.toFixed(2)}`;
        }

        function updateSubmitButton() {
            const rows = document.querySelectorAll('#itemsBody tr');
            document.getElementById('submitBtn').disabled = rows.length === 0;
        }

        // Add first item on load
        addItem();
    </script>
}
